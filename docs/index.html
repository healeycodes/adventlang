<html>

<head>
    <title>Adventlang Playground</title>
    <meta name="description" content="A lil WebAssembly code playground for Adventlang." />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
    <link rel="prefetch" href="wasm_exec.js">
    <link rel="prefetch" href="adventlang.wasm">
</head>

<body>
    <h1>Adventlang Playground</h1>
    <p>A lil WebAssembly code playground.</p>
    <p>See Adventlang code examples in <a href="https://github.com/healeycodes/adventlang/tree/main/tests">/tests</a> or
        <a href="https://github.com/healeycodes/adventlang/tree/main/solutions/2021">/solutions/2021</a>
    </p>
    <textarea rows="13" class="code input"></textarea>
    <button onclick="run()">Run</button>
    <span class="stats"></span>
    <textarea readonly class="code output"></textarea>
    <style>
        .input {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.1rem;
        }

        .output {
            visibility: hidden;
        }
    </style>
    <script>
        let workerPool = [];

        const input = document.querySelector(".input");
        const output = document.querySelector(".output");
        const stats = document.querySelector(".stats");
        let data = `// log() prints to developer console
log("Hello, World!");

let loop_count = 0;
for (let i = 0; i < 10; i = i + 1) {
    loop_count = loop_count + 1;
}

// Final value is output below like in the CLI
loop_count;`;
        input.value = data;

        // Retrieve an idle worker or spawn a new one
        function getWorker() {
            let worker = workerPool.find(worker => worker.ready);
            if (!worker) {
                worker = { id: Math.random(), ready: true, instance: new Worker('worker.js') }
            }
            workerPool.push(worker);
            return worker
        }

        // Start pool with one idle worker
        getWorker();

        // Terminate and remove any running workers
        // apart from `id`
        function garbageCollect(id) {
            const tempPool = [];
            workerPool.forEach(worker => {
                if (worker.id != id) {
                    worker.instance.terminate();
                } else {
                    // Reset workerPool to only contain this worker
                    tempPool.push(worker);
                }
            })
            workerPool = tempPool;
        }

        // Execute input code via worker and display resulting output
        function run() {
            const worker = getWorker();
            worker.ready = false;
            const result = worker.instance.postMessage(input.value);
            worker.instance.onmessage = (e) => {
                output.style.visibility = "visible";
                output.value = e.data[0];
                stats.innerHTML = `<i>${e.data[1]}ms</i>`;
                worker.ready = true;
                garbageCollect(worker.id);
            }
        }
    </script>
</body>

</html>